<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Music Player</title>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-color: #000000;
            --surface-color: #121212;
            --surface-hover: #282828;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --accent-color: #3ecf8e; /* Supabase Green */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
        
        body {
            font-family: 'Circular', -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        #nav-panel {
            width: 240px; background: #000; display: flex; flex-direction: column; padding: 24px; gap: 24px; flex-shrink: 0;
        }
        .logo { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px; color: white; }
        .nav-btn {
            display: flex; align-items: center; gap: 16px; padding: 10px 16px; border-radius: 4px;
            color: var(--text-secondary); font-weight: 700; font-size: 14px; transition: 0.2s; cursor: pointer;
        }
        .nav-btn:hover, .nav-btn.active { color: white; background: var(--surface-hover); }
        .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* --- Main Content --- */
        #main-view {
            flex: 1; background: linear-gradient(180deg, #222 0%, #121212 40%);
            overflow-y: auto; position: relative; padding: 24px 32px; padding-bottom: 120px;
        }
        h2 { font-size: 24px; font-weight: 700; margin-bottom: 20px; color: white; }

        /* Cards */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 24px; margin-bottom: 40px; }
        .music-card {
            background: #181818; padding: 16px; border-radius: 8px; transition: background 0.3s; cursor: pointer;
            position: relative; display: flex; flex-direction: column; gap: 12px;
        }
        .music-card:hover { background: #282828; }
        .card-img-wrap {
            width: 100%; aspect-ratio: 1; border-radius: 4px; overflow: hidden; background: #333; position: relative;
        }
        .card-img-wrap img { width: 100%; height: 100%; object-fit: cover; }
        
        /* List Rows */
        .track-row {
            display: grid; grid-template-columns: 40px 1fr 120px; align-items: center; padding: 10px 16px; border-radius: 4px; color: var(--text-secondary); cursor: pointer;
        }
        .track-row:hover { background: hsla(0,0%,100%,.1); }
        .track-row.active { color: var(--accent-color); }
        .track-title { color: white; font-size: 16px; margin-bottom: 4px; }
        .track-row.active .track-title { color: var(--accent-color); }

        /* --- Footer Player --- */
        #player-footer {
            position: fixed; bottom: 0; left: 0; right: 0; height: 90px; background: #181818; border-top: 1px solid #282828;
            display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 100;
        }
        .footer-left { width: 30%; display: flex; align-items: center; gap: 14px; }
        .current-art { width: 56px; height: 56px; background: #333; border-radius: 4px; overflow: hidden; }
        .current-art img { width: 100%; height: 100%; object-fit: cover; }
        
        .footer-center { width: 40%; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .player-controls { display: flex; gap: 16px; align-items: center; }
        .ctrl-btn { color: #b3b3b3; background: none; border: none; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .ctrl-btn:hover { color: white; }
        .ctrl-btn.main { background: white; color: black; border-radius: 50%; transform: scale(1); }
        
        .progress-bar-area { width: 100%; display: flex; align-items: center; gap: 8px; font-size: 11px; color: #a7a7a7; }
        .progress-rail { flex: 1; height: 4px; background: #4d4d4d; border-radius: 2px; position: relative; cursor: pointer; }
        .progress-fill { height: 100%; background: white; border-radius: 2px; width: 0%; }

        .footer-right { width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .pip-btn { color: #b3b3b3; background: none; border: 1px solid #444; border-radius: 4px; font-size: 10px; padding: 4px 8px; cursor: pointer; }
        .pip-btn:hover { color: white; border-color: white; }

        .hidden { display: none !important; }
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* Visualizer Canvas & Pip Canvas */
        #visualizer { position: absolute; bottom: 0; left: 0; width: 100%; height: 200px; pointer-events: none; opacity: 0.15; z-index: 0; }
        /* Hidden Elements for PiP generation */
        #pip-canvas { display: none; } 

        @media (max-width: 768px) { #nav-panel { display: none; } #main-view { padding: 16px; } }
    </style>
</head>
<body>

    <div style="display:flex; height:100vh;">
        <!-- Nav -->
        <div id="nav-panel">
            <div class="logo">
                <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                <span>MusicPlayer</span>
            </div>
            
            <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                <button class="nav-btn active" onclick="router.go('home')">Home</button>
                <button class="nav-btn" onclick="router.go('library')">Library</button>
                <button class="nav-btn" onclick="router.go('liked')">Liked Songs</button>
            </div>
            <div style="font-size:11px; color:#555;">Powered by Supabase</div>
        </div>

        <!-- Main -->
        <div id="main-view">
            <canvas id="visualizer"></canvas>

            <div id="view-home" class="view-section active">
                <h2>Recommended</h2>
                <div class="card-grid" id="rec-grid">Loading...</div>
                <h2>Recent</h2>
                <div class="card-grid" id="recent-grid"></div>
            </div>

            <div id="view-library" class="view-section">
                <h2>Full Library</h2>
                <div id="lib-list">Loading...</div>
            </div>

            <div id="view-liked" class="view-section">
                <h2>Liked Songs</h2>
                <div id="liked-list"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="player-footer">
        <div class="footer-left">
            <div class="current-art" id="curr-art-img"></div>
            <div style="display:flex; flex-direction:column; margin-left:14px;">
                <div id="p-title" style="color:white; font-size:14px; font-weight:600;">Not Playing</div>
                <div id="p-artist" style="color:#b3b3b3; font-size:11px;">--</div>
            </div>
            <button onclick="player.toggleLike()" id="p-like-btn" class="ctrl-btn" style="margin-left:12px;">❤</button>
        </div>

        <div class="footer-center">
            <div class="player-controls">
                <button class="ctrl-btn" onclick="player.prev()">⏮</button>
                <button class="ctrl-btn main" onclick="player.togglePlay()">
                    <span id="icon-play">▶</span><span id="icon-pause" class="hidden">⏸</span>
                </button>
                <button class="ctrl-btn" onclick="player.next()">⏭</button>
            </div>
            <div class="progress-bar-area">
                <span id="curr-time">0:00</span>
                <div class="progress-rail" id="seek-rail">
                    <div class="progress-fill" id="seek-fill"></div>
                </div>
                <span id="dur-time">0:00</span>
            </div>
        </div>

        <div class="footer-right">
            <button class="pip-btn" onclick="pipManager.toggle()">Mini Player</button>
            <input type="range" min="0" max="1" step="0.05" oninput="audio.volume=this.value" style="width:80px;">
        </div>
    </div>

    <video id="audio-el" crossorigin="anonymous" style="display:none;"></video>
    
    <!-- PiP Helper Elements -->
    <canvas id="pip-canvas" width="500" height="500"></canvas>
    <video id="pip-video" muted style="position:fixed; top:-1000px; width:1px; height:1px;"></video>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = "YOUR_SUPABASE_URL_HERE"; 
        const SUPABASE_KEY = "YOUR_SUPABASE_ANON_KEY_HERE";

        const FALLBACK_LIB = [
            { id: 901, name: "APT.", artist: "Rosé & Bruno Mars", img: "https://placehold.co/300/ff69b4/fff?text=APT", url: "https://raw.githubusercontent.com/Dcode9/MPLayer/58e6474295f9ea49d0ea3f3f911cc157988b39b0/APT..m4a" }
        ];

        let LIBRARY = [];
        let supabase;

        // State
        const state = {
            queue: [],
            idx: -1,
            playing: false,
            likedIds: JSON.parse(localStorage.getItem('likedIds') || '[]')
        };

        // --- INIT ---
        function init() {
            try {
                const { createClient } = window.supabase;
                if (!SUPABASE_URL.includes("YOUR_")) {
                    supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
                    fetchSongs();
                } else {
                    console.warn("Supabase Keys missing. Using Fallback.");
                    LIBRARY = FALLBACK_LIB;
                    ui.render();
                }
            } catch(e) { console.error(e); }
            
            ui.initListeners();
            ui.updateLikeBtn(); 
        }

        async function fetchSongs() {
            const { data, error } = await supabase.from('songs').select('*').order('id', {ascending: false});
            if (data && data.length > 0) LIBRARY = data;
            else LIBRARY = FALLBACK_LIB;
            
            // Fix URLs
            LIBRARY = LIBRARY.map(s => {
                if(s.url.includes('github.com') && !s.url.includes('raw.githubusercontent.com')) {
                   s.url = s.url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/').replace('/raw/', '/');
                }
                return s;
            });
            state.queue = [...LIBRARY];
            ui.render();
        }

        // --- PLAYER ---
        const audio = document.getElementById('audio-el');
        
        audio.onerror = (e) => {
            if(state.playing) {
                state.playing = false;
                ui.updatePlayBtn();
            }
        };

        const player = {
            playTrack: (index) => {
                state.idx = index;
                const track = LIBRARY[index];
                if(!track) return;

                audio.src = track.url;
                audio.play().then(() => {
                    state.playing = true;
                    ui.updatePlayBtn();
                    viz.start();
                    // Update System Media Session
                    mediaSessionManager.update(track);
                    // Update PiP Canvas if active
                    pipManager.drawCanvas(track);
                }).catch(console.error);

                document.getElementById('p-title').textContent = track.name;
                document.getElementById('p-artist').textContent = track.artist;
                
                const artDiv = document.getElementById('curr-art-img');
                if (track.img) artDiv.innerHTML = `<img src="${track.img}">`;
                else artDiv.innerHTML = `<div style="width:100%;height:100%;background:#333;"></div>`;
                
                ui.updateLikeBtn();
            },
            togglePlay: () => {
                if(state.idx === -1) { player.playTrack(0); return; }
                if(state.playing) { audio.pause(); state.playing = false; }
                else { audio.play(); state.playing = true; viz.start(); }
                ui.updatePlayBtn();
                // Update play state for media session
                if(navigator.mediaSession) navigator.mediaSession.playbackState = state.playing ? "playing" : "paused";
            },
            next: () => {
                let next = state.idx + 1;
                if(next >= LIBRARY.length) next = 0;
                player.playTrack(next);
            },
            prev: () => {
                let prev = state.idx - 1;
                if(prev < 0) prev = LIBRARY.length - 1;
                player.playTrack(prev);
            },
            toggleLike: () => {
                if(state.idx === -1) return;
                const id = LIBRARY[state.idx].id;
                const index = state.likedIds.indexOf(id);
                if(index === -1) state.likedIds.push(id);
                else state.likedIds.splice(index, 1);
                localStorage.setItem('likedIds', JSON.stringify(state.likedIds));
                ui.updateLikeBtn();
                ui.render();
            }
        };

        // --- MEDIA SESSION (Notification Controls) ---
        const mediaSessionManager = {
            update: (track) => {
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: track.name,
                        artist: track.artist,
                        artwork: [
                            { src: track.img || 'https://placehold.co/512/333/fff?text=Music', sizes: '512x512', type: 'image/png' }
                        ]
                    });
                    
                    navigator.mediaSession.setActionHandler('play', player.togglePlay);
                    navigator.mediaSession.setActionHandler('pause', player.togglePlay);
                    navigator.mediaSession.setActionHandler('previoustrack', player.prev);
                    navigator.mediaSession.setActionHandler('nexttrack', player.next);
                }
            }
        };

        // --- VISUAL PIP (Mini Player) ---
        const pipManager = {
            video: document.getElementById('pip-video'),
            canvas: document.getElementById('pip-canvas'),
            ctx: document.getElementById('pip-canvas').getContext('2d'),
            active: false,
            
            toggle: async () => {
                if (document.pictureInPictureElement) {
                    document.exitPictureInPicture();
                } else {
                    if (state.idx !== -1) pipManager.drawCanvas(LIBRARY[state.idx]);
                    
                    // Capture stream from canvas
                    const stream = pipManager.canvas.captureStream();
                    pipManager.video.srcObject = stream;
                    await pipManager.video.play();
                    
                    try {
                        await pipManager.video.requestPictureInPicture();
                    } catch(e) {
                        alert("PiP Failed: " + e.message);
                    }
                }
            },
            
            drawCanvas: (track) => {
                const ctx = pipManager.ctx;
                const w = 500, h = 500;
                
                // BG
                ctx.fillStyle = "#111";
                ctx.fillRect(0, 0, w, h);
                
                // Load Image
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = track.img || 'https://placehold.co/500/333/fff?text=No+Art';
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, w, w); // Draw Art
                    // Add Title Overlay (Optional, Art usually has text)
                };
                // Fallback text if image loads slow
                ctx.fillStyle = "white";
                ctx.font = "bold 40px sans-serif";
                ctx.fillText(track.name, 20, 450);
            }
        };

        // --- UI ---
        const router = {
            go: (view) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById('view-'+view).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
                const btns = document.querySelectorAll('.nav-btn');
                if(view==='home') btns[0].classList.add('active');
                if(view==='library') btns[1].classList.add('active');
                if(view==='liked') btns[2].classList.add('active');
            }
        };

        const ui = {
            initListeners: () => {
                document.getElementById('seek-rail').addEventListener('click', (e) => {
                    if(!audio.duration) return;
                    const rect = e.target.getBoundingClientRect();
                    const pct = (e.clientX - rect.left) / rect.width;
                    audio.currentTime = pct * audio.duration;
                });
                audio.addEventListener('timeupdate', () => {
                    if(!audio.duration) return;
                    const pct = (audio.currentTime / audio.duration) * 100;
                    document.getElementById('seek-fill').style.width = pct + '%';
                    const m = Math.floor(audio.currentTime / 60);
                    const s = Math.floor(audio.currentTime % 60);
                    document.getElementById('curr-time').textContent = `${m}:${s.toString().padStart(2,'0')}`;
                });
                audio.addEventListener('loadedmetadata', () => {
                    const m = Math.floor(audio.duration / 60);
                    const s = Math.floor(audio.duration % 60);
                    document.getElementById('dur-time').textContent = `${m}:${s.toString().padStart(2,'0')}`;
                });
                audio.addEventListener('ended', () => player.next());
            },
            render: () => {
                const recGrid = document.getElementById('rec-grid');
                recGrid.innerHTML = LIBRARY.slice(0,4).map(ui.createCard).join('');
                const recentGrid = document.getElementById('recent-grid');
                recentGrid.innerHTML = LIBRARY.slice(4,8).map(ui.createCard).join('');
                
                const libList = document.getElementById('lib-list');
                libList.innerHTML = LIBRARY.map(ui.createRow).join('');

                const likedList = document.getElementById('liked-list');
                const likedTracks = LIBRARY.filter(t => state.likedIds.includes(t.id));
                if(likedTracks.length === 0) likedList.innerHTML = '<div style="color:#666">No liked songs yet.</div>';
                else likedList.innerHTML = likedTracks.map(ui.createRow).join('');
            },
            createCard: (t, i) => `
                <div class="music-card" onclick="player.playTrack(${LIBRARY.indexOf(t)})">
                    <div class="card-img-wrap">
                        ${t.img ? `<img src="${t.img}">` : '<div style="background:#333;height:100%"></div>'}
                    </div>
                    <div style="font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${t.name}</div>
                    <div style="font-size:12px;color:#aaa">${t.artist}</div>
                </div>`,
            createRow: (t, i) => `
                <div class="track-row" onclick="player.playTrack(${LIBRARY.indexOf(t)})">
                    <div>${i+1}</div>
                    <div class="track-title" style="${state.idx === LIBRARY.indexOf(t) ? 'color:var(--accent-color)' : ''}">${t.name}</div>
                    <div style="color:#aaa">${t.artist}</div>
                </div>`,
            updatePlayBtn: () => {
                document.getElementById('icon-play').className = state.playing ? 'hidden' : '';
                document.getElementById('icon-pause').className = state.playing ? '' : 'hidden';
            },
            updateLikeBtn: () => {
                if(state.idx === -1) return;
                const id = LIBRARY[state.idx].id;
                const btn = document.getElementById('p-like-btn');
                btn.style.color = state.likedIds.includes(id) ? 'var(--accent-color)' : '#b3b3b3';
            }
        };

        const viz = {
            ctx: null, source: null, analyser: null,
            start: () => {
                if(viz.ctx) return;
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    viz.ctx = new AudioContext();
                    viz.analyser = viz.ctx.createAnalyser();
                    viz.source = viz.ctx.createMediaElementSource(audio);
                    viz.source.connect(viz.analyser);
                    viz.analyser.connect(viz.ctx.destination);
                    viz.analyser.fftSize = 64;
                    viz.draw();
                } catch(e) {}
            },
            draw: () => {
                requestAnimationFrame(viz.draw);
                const buffer = viz.analyser.frequencyBinCount;
                const data = new Uint8Array(buffer);
                viz.analyser.getByteFrequencyData(data);
                const canvas = document.getElementById('visualizer');
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = 200;
                ctx.clearRect(0,0,canvas.width,canvas.height);
                const barW = canvas.width / buffer;
                for(let i=0; i<buffer; i++) {
                    const barH = data[i]/1.5;
                    ctx.fillStyle = `rgba(62, 207, 142, ${barH/255})`;
                    ctx.fillRect(i*barW, canvas.height-barH, barW, barH);
                }
            }
        };

        init();
    </script>
</body>
</html>
