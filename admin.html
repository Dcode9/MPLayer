<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #111; color: #eee; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: #222; padding: 2rem; border-radius: 8px; width: 100%; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        h1 { margin-top: 0; color: #3ecf8e; text-align: center; }
        label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #aaa; }
        input { width: 100%; padding: 0.5rem; margin-bottom: 1rem; background: #333; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { flex: 1; padding: 0.75rem; border: none; font-weight: bold; border-radius: 4px; cursor: pointer; }
        .add-btn { background: #3ecf8e; color: black; }
        .add-btn:hover { background: #34b27b; }
        .cancel-btn { background: #555; color: white; display: none; }
        .cancel-btn:hover { background: #666; }

        .status { margin-top: 1rem; text-align: center; font-size: 0.9rem; padding: 10px; border-radius: 4px; display: none; }
        .status.show { display: block; }
        .status.success { background: rgba(62, 207, 142, 0.2); color: #3ecf8e; }
        .status.error { background: rgba(233, 30, 99, 0.2); color: #e91e63; }
        
        .connection-bar { margin-bottom: 20px; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 8px; background: #333; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .dot.green { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .dot.yellow { background: #ff9800; box-shadow: 0 0 5px #ff9800; }

        .song-list { margin-top: 2rem; border-top: 1px solid #333; padding-top: 1rem; }
        .song-item { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 10px; margin-bottom: 8px; border-radius: 4px; border: 1px solid #333; }
        .song-info { font-size: 0.9rem; flex: 1; overflow: hidden; padding-right: 10px; }
        .song-title { color: white; font-weight: bold; }
        .action-btns { display: flex; gap: 5px; }
        .sm-btn { padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; width: auto; }
        .delete-btn { background: #e91e63; color: white; }
        .edit-btn { background: #2196F3; color: white; }
    </style>
</head>
<body>

<div class="connection-bar">
    <div id="conn-dot" class="dot yellow"></div>
    <span id="conn-text">Connecting...</span>
</div>

<div class="container">
    <h1>Manage Library</h1>
    
    <div id="add-form">
        <label>Song Title</label>
        <input type="text" id="name" placeholder="e.g. Sapphire">
        <label>Artist</label>
        <input type="text" id="artist" placeholder="e.g. Dcode9">
        <label>Audio URL (Link)</label>
        <input type="text" id="url" placeholder="Paste GitHub link here...">
        <label>Album Art URL (Optional)</label>
        <input type="text" id="img" placeholder="https://...">
        
        <div class="btn-group">
            <button id="submit-btn" class="add-btn" onclick="handleSubmit()">Add Song</button>
            <button id="cancel-btn" class="cancel-btn" onclick="resetForm()">Cancel Edit</button>
        </div>
        <div id="status" class="status"></div>
    </div>

    <div class="song-list">
        <h3 style="color:#aaa; font-size:1rem;">Current Songs</h3>
        <div id="library-list">Loading...</div>
    </div>
</div>

<script>
    let supabase;
    let editingId = null;
    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('library-list');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const connDot = document.getElementById('conn-dot');
    const connText = document.getElementById('conn-text');

    const inpName = document.getElementById('name');
    const inpArtist = document.getElementById('artist');
    const inpUrl = document.getElementById('url');
    const inpImg = document.getElementById('img');

    // --- INITIALIZE ---
    async function init() {
        try {
            // 1. Try fetching from Vercel API
            const response = await fetch('/api/config');
            if (response.ok) {
                const config = await response.json();
                if (config.supabaseUrl && config.supabaseKey) {
                    const { createClient } = window.supabase;
                    supabase = createClient(config.supabaseUrl, config.supabaseKey);
                    connDot.className = "dot green";
                    connText.textContent = "Connected via Vercel Env";
                    fetchSongs();
                    return;
                }
            }
            
            // 2. Fallback: Check for LocalStorage manual entry
            // (Useful for local testing without 'vercel dev')
            throw new Error("API Config not found");
        } catch (e) {
            console.warn("Env fetch failed, checking local config...");
            checkLocalConfig();
        }
    }

    function checkLocalConfig() {
        // Fallback for local testing if API fails
        const url = prompt("Vercel Env not found (are you running locally?). Enter Supabase URL:");
        const key = prompt("Enter Supabase Anon Key:");
        if(url && key) {
            const { createClient } = window.supabase;
            supabase = createClient(url, key);
            connDot.className = "dot green";
            connText.textContent = "Connected Manual";
            fetchSongs();
        } else {
            connDot.className = "dot red";
            connText.textContent = "Not Connected";
        }
    }

    function showStatus(msg, type) {
        statusEl.textContent = msg;
        statusEl.className = `status show ${type}`;
        setTimeout(() => { if(type === 'success') statusEl.className = 'status'; }, 3000);
    }

    function fixGithubUrl(url) {
        if (url.includes('github.com') && url.includes('/blob/')) return url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
        if (url.includes('github.com') && url.includes('/raw/')) return url.replace('github.com', 'raw.githubusercontent.com').replace('/raw/', '/'); 
        return url;
    }

    async function handleSubmit() {
        if (!supabase) return showStatus("Supabase not configured.", "error");

        const name = inpName.value.trim();
        const artist = inpArtist.value.trim();
        let url = inpUrl.value.trim();
        const img = inpImg.value.trim();

        if (!name || !artist || !url) return showStatus("Fill Name, Artist, and URL.", "error");
        
        url = fixGithubUrl(url);
        showStatus(editingId ? "Updating..." : "Adding...", "loading");

        let error;
        if (editingId) {
            const res = await supabase.from('songs').update({ name, artist, url, img }).eq('id', editingId);
            error = res.error;
        } else {
            const res = await supabase.from('songs').insert([{ name, artist, url, img }]);
            error = res.error;
        }

        if (error) showStatus("Error: " + error.message, "error");
        else {
            showStatus(editingId ? "Updated!" : "Added!", "success");
            resetForm();
            fetchSongs();
        }
    }

    function editSong(id, name, artist, url, img) {
        editingId = id;
        inpName.value = name;
        inpArtist.value = artist;
        inpUrl.value = url;
        inpImg.value = img || '';
        submitBtn.textContent = "Update Song";
        cancelBtn.style.display = "block";
        window.scrollTo(0, 0);
    }

    function resetForm() {
        editingId = null;
        inpName.value = '';
        inpArtist.value = '';
        inpUrl.value = '';
        inpImg.value = '';
        submitBtn.textContent = "Add Song";
        cancelBtn.style.display = "none";
    }

    async function fetchSongs() {
        if(!supabase) return;
        listEl.innerHTML = '<div style="color:#666; text-align:center;">Updating list...</div>';
        const { data, error } = await supabase.from('songs').select('*').order('id', { ascending: false });

        if (error) listEl.innerHTML = `<div style="color:red">Error fetching list</div>`;
        else if (data && data.length > 0) {
            listEl.innerHTML = data.map(song => `
                <div class="song-item">
                    <div class="song-info">
                        <div class="song-title">${escapeHtml(song.name)}</div>
                        <div class="song-artist">${escapeHtml(song.artist)}</div>
                    </div>
                    <div class="action-btns">
                        <button class="sm-btn edit-btn" onclick="editSong(${song.id}, '${escapeHtmlAttr(song.name)}', '${escapeHtmlAttr(song.artist)}', '${escapeHtmlAttr(song.url)}', '${escapeHtmlAttr(song.img)}')">Edit</button>
                        <button class="sm-btn delete-btn" onclick="deleteSong(${song.id})">Del</button>
                    </div>
                </div>
            `).join('');
        } else {
            listEl.innerHTML = '<div style="color:#666; text-align:center;">Library is empty.</div>';
        }
    }

    async function deleteSong(id) {
        if(!confirm("Delete this song?")) return;
        const { error } = await supabase.from('songs').delete().eq('id', id);
        if (error) showStatus("Delete failed: " + error.message, "error");
        else fetchSongs();
    }

    function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }
    function escapeHtmlAttr(text) { return text ? text.replace(/'/g, "\\'").replace(/"/g, "&quot;") : ""; }

    init();
</script>
</body>
</html>
